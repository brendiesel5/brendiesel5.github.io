const mediumScreenWidthBreakpoint=650;const largeScreenWidthBreakpoint=900;window.onload=function(){google.accounts.id.initialize({client_id:window.googleClientId,callback:handleCredentialResponse});google.accounts.id.prompt(notification=>{if(notification.isNotDisplayed()||notification.isSkippedMoment()){let welcomBackElement=window.parent.document.getElementById("welcome_back");if(welcomBackElement!==null){welcomBackElement.style.display="block";}}});if(window.parent.innerWidth>mediumScreenWidthBreakpoint){window.parent.addEventListener("resize",adjustPromptHorizontalPosition);}
window.parent.document.getElementById("header").style.zIndex=600;const bodyObserver=new MutationObserver(mutationsList=>{mutationsList.forEach(repositionGoogleIframe);});bodyObserver.observe(document.body,{childList:true});Array.prototype.forEach.call(document.querySelectorAll(".one-tap-prompt__close"),item=>{item.addEventListener("click",event=>{document.querySelector(".one-tap-prompt__wrapper").style.display="none";window.parent.document.getElementById("google-one-tap-iframe").style.display="none";});});};function repositionGoogleIframe(mutation){let iframeElement=window.parent.document.getElementById("google-one-tap-iframe");mutation.removedNodes.forEach(node=>{if(node.id=="credential_picker_container"||node.id=="credential_picker_iframe"){iframeElement.style.display="none";}});mutation.addedNodes.forEach(node=>{if(node.id=="credential_picker_container"&&node.hasChildNodes()){let googleIframeNodes=node.getElementsByTagName("iframe");if(googleIframeNodes){let googleIframe=googleIframeNodes[0];const attributeObserver=new MutationObserver(iframeMutationsList=>{let height=parseInt(iframeMutationsList[0].target.style.height);let width=parseInt(iframeMutationsList[0].target.style.width);iframeElement.height=height;iframeElement.width=width;if(window.parent.innerWidth<=mediumScreenWidthBreakpoint){iframeElement.width=window.parent.innerWidth;node.style.width=window.parent.innerWidth-40;}else{adjustPromptHorizontalPosition();window.parent.addEventListener("resize",adjustPromptHorizontalPosition);}});attributeObserver.observe(googleIframe,{attributes:true});}}else if(node.id=="credential_picker_iframe"){const attributeObserver=new MutationObserver(iframeMutationsList=>{let height=parseInt(iframeMutationsList[0].target.style.height);iframeElement.height=height;iframeElement.width=window.parent.innerWidth;node.style.width=window.parent.innerWidth-40;});attributeObserver.observe(node,{attributes:true});}});}
function handleCredentialResponse(credentialResponse){let request=new XMLHttpRequest();request.open("GET","/register/one-tap-login?_xfResponseType=json&_xfToken="+
XF.config.csrf+
"&_onetap="+
credentialResponse.credential);request.onreadystatechange=function(){if(this.readyState==4){let response=JSON.parse(this.response);if(response.message==="New User"){handleNewUserRegistration(credentialResponse,response);}else if(response.message==="Connecting User"){handleConnectingUser(credentialResponse,response);}else if(response.message==="Succeeded"){pushToGTM("GoogleOneTapLogin");window.parent.location.reload();}else if(response.message==="Redirect"){pushToGTM("GoogleOneTapLogin");if(response.url){window.parent.location.href=response.url;}else{window.parent.location.reload();}}else{window.parent.postMessage("googleOneTapError",window.location.href);}}};request.send();}
function handleNewUserRegistration(credentialResponse,response){let usernameElement=document.getElementById("one-tap-prompt__confirm-username");usernameElement.style.display="block";window.parent.document.getElementById("google-one-tap-iframe").style.display="block";let confirmButton=document.getElementById("one-tap-prompt__username-confirm-button");confirmButton.addEventListener("click",event=>{handleOneTapRegistration(credentialResponse);});window.parent.document.getElementById("google-one-tap-iframe").height=usernameElement.offsetHeight+8;document.querySelector("input[name='email_choice']").checked=response.defaultEmailChoice;let input=document.getElementById("one-tap-prompt__username-input");input.value=response.username;let timeout=null;input.addEventListener("keyup",function(e){clearTimeout(timeout);timeout=setTimeout(function(){validateUsername(input.value);},300);});}
function handleConnectingUser(credentialResponse,response){let fomoElement=document.getElementById("one-tap-prompt__fomo-alert");fomoElement.style.display="block";window.parent.document.getElementById("google-one-tap-iframe").style.display="block";let fomoConfirmElement=document.getElementById("one-tap-prompt__fomo-confirm-button");fomoConfirmElement.addEventListener("click",event=>{handleOneTapRegistration(credentialResponse);});window.parent.document.getElementById("google-one-tap-iframe").height=fomoElement.offsetHeight+8;document.querySelector("input[name='email_choice']").checked=response.defaultEmailChoice;}
function handleOneTapRegistration(credentialResponse){let username=document.getElementById("one-tap-prompt__username-input").value;let email_choice=document.querySelector("input[name='email_choice']").checked?1:0;let usernameElement=document.getElementById("one-tap-prompt__confirm-username");let fomoElement=document.getElementById("one-tap-prompt__fomo-alert");let request=new XMLHttpRequest();request.open("POST","/register/one-tap-connect");request.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");request.onreadystatechange=function(){if(this.readyState!=4){return;}
let response=JSON.parse(this.response);if(response.message==="Succeeded"){usernameElement.style.display="none";pushToGTM("GoogleOneTapRegistration");window.parent.location.reload();}else if(response.message==="Account Connected"){fomoElement.style.display="none";pushToGTM("GoogleOneTapLogin");window.parent.location.reload();}else if(response.message==="Redirect"){pushToGTM("GoogleOneTapLogin");if(response.url){window.parent.location.href=response.url;}else{fomoElement.style.display="none";window.parent.location.reload();}}else if(response.errors&&response.errors.username){disableUsernameUpdateButton(response.errors.username);}else{window.parent.postMessage("googleOneTapError",window.location.href);}};request.send("_xfResponseType=json&_xfToken="+
XF.config.csrf+
"&_onetap="+
credentialResponse.credential+
"&username="+
username+
"&email_choice="+
email_choice);}
function adjustPromptHorizontalPosition(){let iframeElement=window.parent.document.getElementById("google-one-tap-iframe");let adjustWidth=27;if(window.parent.innerWidth<=largeScreenWidthBreakpoint){adjustWidth=18;}
let headerInner=window.parent.document.querySelector(".p-header-inner");let headerLeft=headerInner.offsetLeft;let button=window.parent.document.querySelector("button[qid='navbar-style-chooser-button']");let buttonWidth=button.offsetWidth;let buttonLeft=button.offsetLeft;iframeElement.style.left=headerLeft+
buttonLeft-
iframeElement.offsetWidth+
buttonWidth+
adjustWidth+
"px";}
function validateUsername(username){if(!username){disableUsernameUpdateButton();return;}
let request=new XMLHttpRequest();request.open("GET","/register/validate-username?_xfResponseType=json&_xfToken="+
XF.config.csrf+
"&username="+
username);request.onreadystatechange=function(){if(this.readyState==4){let response=JSON.parse(this.response);let input=document.getElementById("one-tap-prompt__username-input");let button=document.getElementById("one-tap-prompt__username-confirm-button");if(response.status==="ok"&&response.message=="Succeeded"){document.querySelector(".one-tap-prompt__username-input-hint--available").style.display="block";document.querySelector(".one-tap-prompt__username-input-hint--invalid").style.display="none";input.classList.remove("one-tap-prompt__username-input--invalid");input.dataset.isTaken=false;button.classList.remove("one-tap-prompt__button--disabled");button.disabled=false;}else{disableUsernameUpdateButton(response.message);}
let iframe=window.parent.document.getElementById("google-one-tap-iframe");iframe.height=document.getElementById("one-tap-prompt__confirm-username").offsetHeight+8;}};request.send();}
function disableUsernameUpdateButton(message){let input=document.getElementById("one-tap-prompt__username-input");let button=document.getElementById("one-tap-prompt__username-confirm-button");document.querySelector(".one-tap-prompt__username-input-hint--available").style.display="none";let usernameInvalidElement=document.querySelector(".one-tap-prompt__username-input-hint--invalid");usernameInvalidElement.style.display="block";usernameInvalidElement.innerHTML=message?message:usernameInvalidElement.innerHTML;input.classList.add("one-tap-prompt__username-input--invalid");input.dataset.isTaken=true;button.classList.add("one-tap-prompt__button--disabled");button.disabled=true;let iframe=window.parent.document.getElementById("google-one-tap-iframe");iframe.height=document.getElementById("one-tap-prompt__confirm-username").offsetHeight+
8;}
function pushToGTM(event){window.parent.dataLayer.push({event:event});}